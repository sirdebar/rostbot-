import asyncio
import logging
from aiogram import Dispatcher, Bot, F
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession

from database.base import async_session
from database.repositories import UserRepository, PasswordRepository, LogRepository, SessionRepository
from keyboards import get_admin_inline_keyboard, get_worker_inline_keyboard
from states import AuthState

logger = logging.getLogger(__name__)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
async def get_welcome_message(user_id: int) -> str:
    """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–æ—Ç–µ"""
    welcome_text = f"–¢–≤–æ–π üÜî {user_id}\n\n"
    welcome_text += "–ë–æ—Ç –¥–ª—è —É–¥–æ–±–Ω–æ–π –≤—ã–¥–∞—á–∏ –ª–æ–≥–æ–≤ WhatsApp –∑–∞–ø—É—â–µ–Ω! –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã —Å—Ç–∞–ª–æ –ø—Ä–æ—â–µ –∏ –±—ã—Å—Ç—Ä–µ–µ.\n\n"
    welcome_text += "–ü–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å: @wrldxrd. (https://t.me/wrldxrd)"
    
    return welcome_text

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
async def cmd_start(message: Message, bot: Bot, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏ –º–∞—à—É—â–µ–π —Ä—É–∫–∏
    greeting_message = await message.answer("üëã")
    
    # –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É –∏ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await asyncio.sleep(1)
    await bot.delete_message(chat_id=message.chat.id, message_id=greeting_message.message_id)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    async with async_session() as session:
        user_repo = UserRepository(session)
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user, created = await user_repo.get_or_create_user(
            user_id=message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name,
            last_name=message.from_user.last_name
        )
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        if user.is_admin:
            welcome_text = await get_welcome_message(message.from_user.id)
            
            await message.answer(
                welcome_text,
                reply_markup=get_admin_inline_keyboard(),
                disable_web_page_preview=True
            )
            await state.clear()
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω (—É–∂–µ –≤–≤–µ–ª –ø–∞—Ä–æ–ª—å —Ä–∞–Ω–µ–µ), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        elif user.is_active:
            welcome_text = await get_welcome_message(message.from_user.id)
            
            await message.answer(
                welcome_text,
                reply_markup=get_worker_inline_keyboard(),
                disable_web_page_preview=True
            )
            await state.clear()
        else:
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
            await message.answer(
                "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:"
            )
            await state.set_state(AuthState.waiting_for_password)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
async def process_password(message: Message, state: FSMContext, bot: Bot) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è"""
    # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    async with async_session() as session:
        password_repo = PasswordRepository(session)
        user_repo = UserRepository(session)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
        password_valid = await password_repo.use_password(message.text)
        
        if password_valid:
            # –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = await user_repo.get_by_user_id(message.from_user.id)
            if not user.is_active:
                await user_repo.update_user(message.from_user.id, is_active=True)
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
            welcome_text = await get_welcome_message(message.from_user.id)
            
            await message.answer(
                welcome_text,
                reply_markup=get_worker_inline_keyboard(),
                disable_web_page_preview=True
            )
            await state.clear()
        else:
            # –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–Ω—ã–π, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
            await message.answer(
                "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:"
            )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫ –¥–ª—è –∞–¥–º–∏–Ω–∞
async def admin_button_handler(callback: CallbackQuery, state: FSMContext, bot: Bot) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫ –¥–ª—è –∞–¥–º–∏–Ω–∞"""
    action = callback.data
    
    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —á–∞—Å—ã –∑–∞–≥—Ä—É–∑–∫–∏
    await callback.answer()
    
    if action == "admin_passwords":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∞—Ä–æ–ª–µ–π
        from handlers.admin import show_passwords
        await show_passwords(callback.message)
    elif action == "admin_users":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        from handlers.admin import show_users
        await show_users(callback.message)
    elif action == "admin_upload_logs":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤
        from handlers.admin import upload_logs
        await upload_logs(callback.message, state)
    elif action == "admin_stop_logs":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–æ–≥–æ–≤
        from handlers.admin import stop_logs
        await stop_logs(callback.message)
    elif action == "admin_allow_logs":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ª–æ–≥–æ–≤
        from handlers.admin import allow_logs
        await allow_logs(callback.message)
    elif action == "admin_clear_logs":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤
        from handlers.admin import clear_logs
        await clear_logs(callback.message)
    elif action == "admin_broadcast":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        from handlers.admin import broadcast_message
        await broadcast_message(callback, state)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫ –¥–ª—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
async def worker_button_handler(callback: CallbackQuery, state: FSMContext, bot: Bot) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫ –¥–ª—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞"""
    action = callback.data
    
    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —á–∞—Å—ã –∑–∞–≥—Ä—É–∑–∫–∏
    await callback.answer()
    
    if action == "worker_statistics":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        from handlers.worker import show_statistics_inline
        await show_statistics_inline(callback)
    elif action == "worker_empty_log":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—É—Å—Ç—ã—Ö –ª–æ–≥–æ–≤
        from handlers.worker import empty_log
        await empty_log(callback.message, state)
    elif action == "worker_take_logs":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∑—è—Ç–∏—è –ª–æ–≥–æ–≤
        from handlers.worker import take_logs
        await take_logs(callback.message, state)
    elif action == "worker_your_logs":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
        from handlers.worker import show_user_logs
        await show_user_logs(callback.message, bot)

def register_common_handlers(dp: Dispatcher, bot: Bot) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ–±—â–∏—Ö –∫–æ–º–∞–Ω–¥"""
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
    dp.message.register(cmd_start, Command("start"))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
    dp.message.register(process_password, AuthState.waiting_for_password)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫
    dp.callback_query.register(admin_button_handler, F.data.startswith("admin_"))
    dp.callback_query.register(worker_button_handler, F.data.startswith("worker_")) 